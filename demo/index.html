<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>WebGL Globe</title>
    <meta charset="utf-8">
    <style type="text/css">
      html{
        height: 100%;
      }
      body {
        margin: 0;
        padding: 0;
        border: 0;
        overflow-y:hidden;
        overflow-x:hidden;
        height: 100%;
        background: #000000 url("img/loading.gif") center center no-repeat;
      }
      #universe{
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        border: 0;
      }
    </style>
  </head>
  <body>

    <div id="universe"></div>
    <audio id="aquiring_position" preload="auto" src="sounds/acquiring_position.ogg"></audio> 
    <audio id="crosshair_locked" preload="auto" src="sounds/crosshair_locked.ogg"></audio> 
    <audio id="logon_established" preload="auto" src="sounds/logon_established.ogg"></audio> 
    <audio id="zoom_sound" preload="auto" src="sounds/zoom_sound.ogg"></audio> 
    <audio id="downloading_latest_intel_package" preload="auto" src="sounds/downloading_latest_intel_package.ogg"></audio> 
    <!--logon_established-->
    
    <script type="text/javascript" src="js/Detector.js"></script>
    <script type="text/javascript" src="js/three.js"></script>
    <script type="text/javascript" src="js/stats.js"></script>
    <script type="text/javascript" src="js/Tween.js"></script>
    <script type="text/javascript" src="js/myOrbit.js"></script>
    <script type="text/javascript" src="js/myHUD.js"></script>
    <script type="text/javascript">
      /*
        @coder paremeter-pollution / https://github.com/parameter-pollution/
      */

      //audio controls:
      var aquiring_position=document.getElementById('aquiring_position');
      var crosshair_locked=document.getElementById('crosshair_locked');
      var logon_established=document.getElementById('logon_established');
      var zoom_sound=document.getElementById('zoom_sound');
      var downloading_latest_intel_package=document.getElementById('downloading_latest_intel_package');

       // standard global variables
      var container, scene, camera, renderer, clock, controls, stats, projector;

      // custom global variables
      var middle_earth={x:0,y:0,z:0};
      var orbit;
       
      var earth;
      var earth_radius=50;
      var layers= new Array(10);
      var layer_distance=0.005;

      var hud;
      var hud_distance=30;

      var crosshairTrackingPoint=new THREE.Vector3(25,25,25);

      var randomPointInterval;

      var numberOfTextures=3;

      if(!Detector.webgl){  //check for webgl support
        Detector.addGetWebGLMessage(); //Tell the user that his browser doesn't support webgl
      } else {    
        // initialization
        init();
      }

      function textureLoadComplete(){
        numberOfTextures--;
        if( numberOfTextures === 0 ){ //all textures have been loaded, let's get this party started ;-)
          orbit.tween_to_orbit( { distance: 200}, 4000, TWEEN.Easing.Exponential.Out, function(){
            playSound(aquiring_position);
            setTimeout( function(){
              playSound(logon_established);
            }, 2000);
          });

        randomPointInterval = setInterval( generateRandomTrackingPoint , 2000);
          //start render loop
          animate();
        }     
      }

      function init()
      {

        scene = new THREE.Scene();
        clock = new THREE.Clock();
              
        // set up camera
        camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 2000);
        camera.up.set(0,0,1);

        //HUD
        hud = new myHUD(camera,hud_distance);
        
        //crosshair
        var crosshairGeometry = new THREE.PlaneGeometry( 40, 30 ); 
        var crosshairMaterial = new THREE.MeshLambertMaterial( { map: THREE.ImageUtils.loadTexture('img/crosshair.png', null, textureLoadComplete), transparent:true, opacity:0.3 } ); 
        crosshair = new THREE.Mesh(crosshairGeometry, crosshairMaterial);
        hud.addTracked(crosshair, crosshairTrackingPoint);

        // add the camera to the scene
        scene.add(camera);   
   
        orbit=new myOrbit( camera, middle_earth, 500, clock );    
          
        // create renderer
        renderer = new THREE.WebGLRenderer( {antialias:true} );
        renderer.setSize(window.innerWidth, window.innerHeight);
        
        // render container
        container = document.getElementById( 'universe' );

        
        // attach renderer to the container div
        container.appendChild( renderer.domElement );
        
        
        // create a light
        var ambientLight = new THREE.AmbientLight(0xFFFFFF);
         scene.add(ambientLight);
        

        // sphere parameters: radius, segments along width, segments along height
        var earthGeometry = new THREE.SphereGeometry( earth_radius, 64, 32 ); 
        var earthMaterial = new THREE.MeshLambertMaterial( { map: THREE.ImageUtils.loadTexture('img/borders.jpg', null, textureLoadComplete) } ); 
        earth = new THREE.Mesh(earthGeometry, earthMaterial);
        earth.rotation.set(Math.PI/2,0,0);
        

        // layers
        var layerMaterial = new THREE.MeshLambertMaterial( { map: THREE.ImageUtils.loadTexture('img/layer.png', null, textureLoadComplete), transparent:true, opacity:0.1 } ); 
        

        //this function doesn't work when you start with adding layers with lower scale. but i have NO FUCKING IDEA why ^^
        //if you decide to change it around and find yourself changing it back again increase this counter: 3
        var scale=1+layer_distance*layers.length;
        for (var i = 0; i < layers.length; i++) {
          layers[i] = new THREE.Mesh(earthGeometry, layerMaterial);
          layers[i].scale.set( scale, scale, scale  );
          earth.add(layers[i]);
          scale -= layer_distance;
        }

        scene.add(earth);

        renderer.initWebGLObjects( scene );
       
        projector = new THREE.Projector();

        document.addEventListener( 'mousedown', onDocumentMouseDown, false );
        window.addEventListener( 'resize', onWindowResize, false );          
      }

      function animate() 
      {
          requestAnimationFrame( animate );
          render();   
      }

      function render() 
      { 
        
        TWEEN.update();

        orbit.update(); 

        hud.update();
            
        renderer.clear();    
        renderer.render( scene, orbit.camera );
      }

      function onDocumentMouseDown( event ) {

        event.preventDefault();

        var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
        projector.unprojectVector( vector, camera );

        var raycaster = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );

        var intersects = raycaster.intersectObject( earth );

        if ( intersects.length > 0 ) { //bazinga, we found an intersection point
          orbit.fixAzimuth();
          orbit.autoRotate=false;
          window.clearInterval(randomPointInterval);
          randomPointInterval=null;

          hud.updateTrackingPoint( new THREE.Vector3(intersects[0].point.x, intersects[0].point.y, intersects[0].point.z) );

          var spherical=orbit.convertCartesionToSpherical( intersects[0].point );
          
          playSound(zoom_sound);
          playSound(downloading_latest_intel_package);

          orbit.tween_to_orbit(spherical, 3000, TWEEN.Easing.Cubic.InOut, function(){ 
            orbit.reset();
           
            hud.updateTrackingPoint(new THREE.Vector3(0,0,0));
            if( randomPointInterval === null ) { randomPointInterval = setInterval( generateRandomTrackingPoint , 2000); };

            //TODO: this timeout should not be necessary         
            setTimeout( function(){
              orbit.tween_to_orbit( { distance: 200}, 3000, TWEEN.Easing.Exponential.Out, function(){
                playSound(aquiring_position);
                setTimeout( function(){
                  playSound(logon_established);
                }, 2000);
              });
            }, 50); 
          });
         
        }
      }

      function onWindowResize( event ) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
      }

      function generateRandomTrackingPoint(){
        var min_azimuth=orbit.spherical.azimuth-0.5;
        var max_azimuth=min_azimuth+Math.PI/2;
        var spherical={};
        spherical.azimuth = getRandomNumber(min_azimuth,max_azimuth);
        spherical.inclination = getRandomNumber( 0.4, Math.PI-0.4 );
        spherical.distance = earth_radius;

        var point=orbit.convertSphericalToCartesian(spherical);
        hud.updateTrackingPoint(new THREE.Vector3(point.x, point.y, point.z));
        playSound(crosshair_locked);
      }

      function getRandomNumber(min, max) {
        return Math.random() * (max - min) + min;
      }

      function playSound(sound){
        sound.pause();
        sound.currentTime=0;
        sound.play();
      }
     
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42384097-1', 'github.com');
      ga('send', 'pageview');
    </script>

  </body>
</html>
